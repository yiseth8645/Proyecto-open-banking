import os
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import classification_report
import joblib

# Ruta del caso E
CASE_E_PATH = r"C:\Users\Admin\Desktop\Proyecto open banking\casos_uso\caso_E_oportunidades_producto.csv"
OUTPUT_DIR = r"C:\Users\Admin\Desktop\Proyecto open banking\model_outputs"
os.makedirs(OUTPUT_DIR, exist_ok=True)

# Carga del archivo
df = pd.read_csv(CASE_E_PATH, encoding="latin-1")
df.columns = [c.strip() for c in df.columns]

# Diagnóstico inicial
num_cols = df.select_dtypes(include=[np.number]).columns.tolist()
nan_count = df.isna().sum().sort_values(ascending=False).head(10)

# Si POTENCIAL_CREDITO no está, se crea
if "POTENCIAL_CREDITO" not in df.columns:
    df["POTENCIAL_CREDITO"] = df["TOTAL_AHORROS"] * 0.2

# Se binariza el target por mediana
median_val = df["POTENCIAL_CREDITO"].median()
df["OBJ_BIN"] = (df["POTENCIAL_CREDITO"] > median_val).astype(int)

# Columnas a excluir
exclude_prefix = [
    "TIPO DE ENTIDAD", "CODIGO DE LA ENTIDAD", "NOMBRE DE LA ENTIDAD", "FECHA DE CORTE",
    "UNIDAD DE CAPTURA", "DEPARTAMENTO", "MUNICIPIO", "RENGLON", "TIPO"
]
exclude_cols = [c for c in df.columns if any(e == c for e in exclude_prefix)]

# Selección de variables numéricas útiles
numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()
features = [
    c for c in numeric_cols 
    if c not in ("OBJ_BIN", "POTENCIAL_CREDITO") and c not in exclude_cols
]

# Eliminación de columnas constantes
const_cols = [c for c in features if df[c].nunique(dropna=True) <= 1]
features = [c for c in features if c not in const_cols]

# Matrices finales
X = df[features].fillna(0)
y = df["OBJ_BIN"]

# Split de datos
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.30, stratify=y, random_state=42
)

# Entrenamiento de Random Forest
clf = RandomForestClassifier(n_estimators=200, random_state=42, class_weight="balanced")
clf.fit(X_train, y_train)

# Predicción
y_pred = clf.predict(X_test)

# Reporte de desempeño
print(classification_report(y_test, y_pred, digits=4))

# Importancias de variables
importances = pd.Series(clf.feature_importances_, index=features).sort_values(ascending=False)
top_imp = importances.head(15)

# Gráfica de importancias
plt.figure(figsize=(10,8))
top_imp[::-1].plot(kind="barh")
plt.title("Top importancias (clasificación - Caso E)")
plt.xlabel("Importancia")
plt.tight_layout()
plt.savefig(os.path.join(OUTPUT_DIR, "importancias_caso_E.png"), dpi=150)
plt.show()

# Guardar modelo
joblib.dump(clf, os.path.join(OUTPUT_DIR, "rf_model_caso_E.pkl"))

# Guardar predicciones
df_out = df.copy()
df_out["PROB_POS"] = clf.predict_proba(X.fillna(0))[:,1]
df_out["PRED_BIN"] = clf.predict(X.fillna(0))
df_out.to_csv(os.path.join(OUTPUT_DIR, "caso_E_results_with_preds.csv"),
              index=False, encoding="latin-1")
